# https://docs.zephyrproject.org/latest/reference/kconfig/index-all.html

###############################################################################

# Application specific

CONFIG_DISCOVERY_SERVER=y
# CONFIG_DISCOVERY_SERVER_LOG_LEVEL=4

CONFIG_MAX_HTTP_CONNECTIONS=3

CONFIG_SYSTEM_MONITORING=y

CONFIG_CANTCP_SERVER=n

CONFIG_CANIOT_CONTROLLER=y

###############################################################################

# GENERAL

# fs function needs a lot of stack/ram in general
CONFIG_MAIN_STACK_SIZE=2048

# https://docs.zephyrproject.org/latest/reference/kernel/threads/workqueue.html#configuration-options
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2024
CONFIG_SYSTEM_WORKQUEUE_PRIORITY=-1
CONFIG_SYSTEM_WORKQUEUE_NO_YIELD=n

CONFIG_INIT_STACKS=y

CONFIG_TIMEOUT_64BIT=y

CONFIG_POSIX_API=y
CONFIG_MINIMAL_LIBC=y
CONFIG_MINIMAL_LIBC_MALLOC=y
CONFIG_MINIMAL_LIBC_MALLOC_ARENA_SIZE=1024

CONFIG_POLL=y

###############################################################################

# LOGGING
# https://docs.zephyrproject.org/latest/reference/logging/index.html
CONFIG_LOG=y
CONFIG_PRINTK=y

# CONFIG_CONSOLE=y
# CONFIG_UART_CONSOLE=y
# CONFIG_STDOUT_CONSOLE=y

CONFIG_CBPRINTF_FP_SUPPORT=y

CONFIG_LOG_STRDUP_MAX_STRING=64
CONFIG_LOG_STRDUP_BUF_COUNT=42
CONFIG_LOG_BUFFER_SIZE=2048
# CONFIG_LOG_MODE_DEFERRED=

# enable to immediate while debugging or when having immediate response is needed
# disable to log time sensitive functions (need a bit more RAM for a thread and pools)
CONFIG_LOG_MODE_IMMEDIATE=n

###############################################################################

# DEBUG
CONFIG_ASSERT=n

CONFIG_THREAD_MONITOR=n

# https://docs.zephyrproject.org/latest/guides/flash_debug/thread-analyzer.html
# -> disable CONFIG_LOG_MODE_IMMEDIATE when using THREAD analyser
CONFIG_THREAD_NAME=y
CONFIG_THREAD_ANALYZER=n            
# CONFIG_THREAD_ANALYZER_USE_PRINTK=n
# CONFIG_THREAD_ANALYZER_USE_LOG=y
# CONFIG_THREAD_ANALYZER_AUTO=y
# CONFIG_THREAD_ANALYZER_AUTO_INTERVAL=10
# THREAD_ANALYZER_AUTO_STACK_SIZE
CONFIG_THREAD_RUNTIME_STATS=y

# don't use test random generator in production
CONFIG_TEST_RANDOM_GENERATOR=n

###############################################################################

CONFIG_NETWORKING=y
CONFIG_NET_UDP=y
CONFIG_NET_TCP=y

CONFIG_NET_STATISTICS=y
CONFIG_NET_STATISTICS_USER_API=y
CONFIG_NET_STATISTICS_IPV4=y
CONFIG_NET_STATISTICS_ICMP=y
CONFIG_NET_STATISTICS_TCP=y
CONFIG_NET_STATISTICS_UDP=y

CONFIG_ETH_STM32_HAL_RANDOM_MAC=n
CONFIG_ETH_STM32_HAL_MAC3=77
CONFIG_ETH_STM32_HAL_MAC4=77
CONFIG_ETH_STM32_HAL_MAC5=77

CONFIG_NET_IPV4=y
CONFIG_NET_IPV6=n
CONFIG_NET_TCP=y
CONFIG_NET_ARP=y
CONFIG_NET_UDP=y
CONFIG_NET_SHELL=n

# TO DEBUG
# CONFIG_NET_DRIVERS=y
# CONFIG_NET_LOOPBACK=y
# CONFIG_NET_LOOPBACK_LOG_LEVEL_DBG=y
# CONFIG_NET_IF_MAX_IPV4_COUNT=2

CONFIG_NET_MGMT=y
CONFIG_NET_MGMT_EVENT=y

CONFIG_NET_SOCKETS=y

CONFIG_NET_SOCKETS_SOCKOPT_TLS=y
CONFIG_NET_SOCKETS_TLS_MAX_CONTEXTS=4

# https://github.com/zephyrproject-rtos/zephyr/issues/39705
# incompatible with CONFIG_POSIX_API option
# CONFIG_NET_SOCKETS_POSIX_NAMES=y

CONFIG_NET_BUF_DATA_SIZE=128
# default 36
CONFIG_NET_PKT_RX_COUNT=64
CONFIG_NET_PKT_TX_COUNT=64
CONFIG_NET_BUF_RX_COUNT=64
CONFIG_NET_BUF_TX_COUNT=64

# not entropy in delay
CONFIG_NET_DHCPV4=y
CONFIG_NET_DHCPV4_INITIAL_DELAY_MAX=2
CONFIG_NET_DHCPV4_LOG_LEVEL_DBG=n

CONFIG_DNS_RESOLVER=y
CONFIG_DNS_RESOLVER_ADDITIONAL_BUF_CTR=5
CONFIG_DNS_RESOLVER_ADDITIONAL_QUERIES=2
CONFIG_DNS_RESOLVER_AI_MAX_ENTRIES=4

CONFIG_DNS_RESOLVER_MAX_SERVERS=1
# https://docs.zephyrproject.org/latest/reference/kconfig/CONFIG_DNS_SERVER1.html#std-kconfig-CONFIG_DNS_SERVER1
# SET CONFIG_DNS_RESOLVER_MAX_SERVERS to 2 if enabling next configuration option
# CONFIG_DNS_SERVER2="192.168.10.6"

CONFIG_DNS_RESOLVER_LOG_LEVEL_DBG=y

# CONFIG_MDNS_RESOLVER=y
# CONFIG_LLMNR_RESOLVER=n
# CONFIG_DNS_RESOLVER_MAX_SERVERS=2
# CONFIG_DNS_SERVER_IP_ADDRESSES=y
# CONFIG_DNS_NUM_CONCUR_QUERIES=5

# Config SNTP
CONFIG_SNTP=y
CONFIG_SNTP_LOG_LEVEL_DBG=n

CONFIG_NET_LOG=y
# IMPORTANT - should also be enabled when debugging MBEDTLS stack
CONFIG_NET_SOCKETS_LOG_LEVEL_DBG=n
CONFIG_NET_IF_LOG_LEVEL_INF=y
CONFIG_NET_TCP_LOG_LEVEL_DBG=n
CONFIG_NET_CONFIG_LOG_LEVEL_DBG=n
CONFIG_NET_L2_ETHERNET_LOG_LEVEL_INF=n
CONFIG_NET_CORE_LOG_LEVEL_DBG=n
CONFIG_NET_CONN_LOG_LEVEL_DBG=n

CONFIG_NET_CONFIG_SETTINGS=n
CONFIG_NET_CONFIG_AUTO_INIT=n
CONFIG_NET_CONFIG_CLOCK_SNTP_INIT=n
CONFIG_NET_CONFIG_NEED_IPV6=n
CONFIG_NET_CONFIG_NEED_IPV4=n

CONFIG_NET_MAX_CONN=12
CONFIG_NET_MAX_CONTEXTS=12
CONFIG_POSIX_MAX_FDS=16
CONFIG_NET_SOCKETS_POLL_MAX=7

# https://docs.zephyrproject.org/latest/reference/kconfig/CONFIG_NET_TCP_TIME_WAIT_DELAY.html#std-kconfig-CONFIG_NET_TCP_TIME_WAIT_DELAY
# free TCP context immediately when closed
CONFIG_NET_TCP_TIME_WAIT_DELAY=0

# https://docs.zephyrproject.org/latest/reference/kconfig/CONFIG_NET_TCP_BACKLOG_SIZE.html#std-kconfig-CONFIG_NET_TCP_BACKLOG_SIZE
CONFIG_NET_TCP_BACKLOG_SIZE=5

###############################################################################

CONFIG_MBEDTLS_BUILTIN=y

# we disable heap as we will allocate it manually in CCM Pusing mbedtls_memory_buffer_alloc_init
CONFIG_MBEDTLS_ENABLE_HEAP=n
# CONFIG_MBEDTLS_HEAP_SIZE=65536

CONFIG_MBEDTLS_SSL_MAX_CONTENT_LEN=4096
CONFIG_NET_SOCKETS_TLS_SET_MAX_FRAGMENT_LENGTH=y

CONFIG_MBEDTLS_CFG_FILE="config-tls-generic.h"
CONFIG_MBEDTLS_USER_CONFIG_ENABLE=y
CONFIG_MBEDTLS_USER_CONFIG_FILE="caniot-cfg.h"

CONFIG_MBEDTLS_CIPHER=y

# CONFIG_MBEDTLS_MAC_ALL_ENABLED=y
CONFIG_MBEDTLS_MAC_MD5_ENABLED=y
CONFIG_MBEDTLS_MAC_SHA1_ENABLED=y
CONFIG_MBEDTLS_MAC_SHA256_ENABLED=y
CONFIG_MBEDTLS_MAC_SHA512_ENABLED=y

# CONFIG_MBEDTLS_CIPHER_ALL_ENABLED=y
# CONFIG_MBEDTLS_CIPHER_AES_ENABLED=y
CONFIG_MBEDTLS_CIPHER_MODE_CBC_ENABLED=y

# CONFIG_MBEDTLS_KEY_EXCHANGE_ALL_ENABLED=y
# CONFIG_MBEDTLS_KEY_EXCHANGE_ECDHE_RSA_ENABLED=y
# CONFIG_MBEDTLS_KEY_EXCHANGE_ECDH_RSA_ENABLED=y
CONFIG_MBEDTLS_KEY_EXCHANGE_RSA_ENABLED=y

# CONFIG_MBEDTLS_ECP_ALL_ENABLED=y

# TODO set to off later
CONFIG_MBEDTLS_PEM_CERTIFICATE_FORMAT=y

### ???
CONFIG_CRYPTO=y

### ???
CONFIG_ENTROPY_GENERATOR=y
CONFIG_ENTROPY_DEVICE_RANDOM_GENERATOR=y
# CONFIG_MBEDTLS_ENTROPY_ENABLED=y

CONFIG_MBEDTLS_TLS_VERSION_1_2=y
CONFIG_MBEDTLS_TLS_VERSION_1_1=n
CONFIG_MBEDTLS_TLS_VERSION_1_0=n

# Debug
CONFIG_MBEDTLS_DEBUG=y
CONFIG_MBEDTLS_DEBUG_LEVEL=1
CONFIG_MBEDTLS_MEMORY_DEBUG=y

###############################################################################

CONFIG_CAN=y
CONFIG_CAN_INIT_PRIORITY=80
CONFIG_CAN_MAX_FILTER=5

# this is default
# CONFIG_CAN_LOOPBACK_TX_MSGQ_SIZE=16
# CONFIG_CAN_LOOPBACK_TX_THREAD_PRIORITY=2
# CONFIG_CAN_LOOPBACK_TX_THREAD_STACK_SIZE=256

CONFIG_CAN_LOG_LEVEL_DBG=n
CONFIG_CAN_LOOPBACK=n

###############################################################################

CONFIG_SERIAL=y
CONFIG_UART_ASYNC_API=y
CONFIG_DMA_LOG_LEVEL_DBG=y
# CONFIG_UART_STM32=y (autoselected)

###############################################################################

CONFIG_ADC=y
CONFIG_ADC_LOG_LEVEL_DBG=n

###############################################################################

CONFIG_SENSOR=y
CONFIG_STM32_TEMP=y

###############################################################################

CONFIG_BOOTLOADER_MCUBOOT=n

# use code partition defined in the .overlay files
CONFIG_USE_DT_CODE_PARTITION=y

###############################################################################

CONFIG_MPU_ALLOW_FLASH_WRITE=y

CONFIG_FLASH=y
CONFIG_FLASH_MAP=y

CONFIG_FLASH_PAGE_LAYOUT=y

# Enabling shell, disables logs
# CONFIG_SHELL=y
# CONFIG_FLASH_SHELL=y

###############################################################################

CONFIG_GPIO=y
CONFIG_PWM=y

CONFIG_PWM_LOG_LEVEL_DBG=y

###############################################################################

CONFIG_EVENTFD=y
CONFIG_EVENTFD_MAX=1

###############################################################################

CONFIG_HTTP_CLIENT=y
CONFIG_HTTP_PARSER=y
CONFIG_JSON_LIBRARY=y

###############################################################################

CONFIG_UART_IPC_FULL=y
CONFIG_UART_IPC_DEBUG_GPIO_STM32=y
CONFIG_UART_IPC_PING=y
CONFIG_UART_IPC_PING_PERIOD=1000
CONFIG_UART_IPC_STATS=y
CONFIG_UART_IPC_EVENT_API=y

###############################################################################

CONFIG_CANIOT_LIB=y

CONFIG_CANIOT_LOG_LEVEL=4
CONFIG_CANIOT_ASSERT=n
CONFIG_CANIOT_MAX_PENDING_QUERIES=6
CONFIG_CANIOT_DRIVERS_API=n
CONFIG_CANIOT_CTRL_DRIVERS_API=n

###############################################################################

CONFIG_MY_STM32_HAL=y

###############################################################################